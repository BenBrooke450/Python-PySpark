


from pyspark.sql.functions import col, lit, when, count, row_number, concat, upper, rank,sum
from pyspark.sql.window import Window
from pyspark.sql.types import IntegerType



df = spark.read.format("csv").option("header", True).load("/FileStore/balanced_dataset_50_50.csv")



df.show(10)
+--------+---------+-----------+-------------+--------------+-----------+--------------+--------------+-------+
|    type|   amount|   nameOrig|oldbalanceOrg|newbalanceOrig|   nameDest|oldbalanceDest|newbalanceDest|isFraud|
+--------+---------+-----------+-------------+--------------+-----------+--------------+--------------+-------+
|TRANSFER|129526.58|C1786736565|          0.0|           0.0|C1189777296|    2103690.88|    2233217.46|    0.0|
| CASH_IN|304210.97|C2138211913|   6638620.67|    6942831.64|C1766776273|      513871.6|     209660.63|    0.0|
|CASH_OUT| 57905.63| C393598530|        188.0|           0.0| C769319919|     611506.02|     669411.65|    0.0|
| CASH_IN|  83102.7| C807731926|   2274365.81|    2357468.51| C322340400|     122204.31|      39101.61|    0.0|
| PAYMENT| 14341.19| C603392505|     459181.0|     444839.81|M1570710058|           0.0|           0.0|    0.0|
| PAYMENT| 10212.21|C1780417328|      10715.0|        502.79| M170738948|           0.0|           0.0|    0.0|
| PAYMENT|  4557.25|C1617197023|          0.0|           0.0|M1641433507|           0.0|           0.0|    0.0|
| CASH_IN|300262.27|C1083930398|   1635562.54|    1935824.81|C1829927547|     629770.37|      329508.1|    0.0|
| PAYMENT|  4333.46| C495369998|          0.0|           0.0| M209936230|           0.0|           0.0|    0.0|
| CASH_IN| 27570.04|C1884585626|   5912789.84|    5940359.87|C1109638648|      668281.5|     640711.47|    0.0|
+--------+---------+-----------+-------------+--------------+-----------+--------------+--------------+-------+
only showing top 10 rows




#df = df.withColumnsRenamed({"type":"Type","amount":"Amount","nameOrig":"Original_Name"})

df = df.withColumnRenamed("type","Type") \
    .withColumnRenamed("amount","Amount") \
    .withColumnRenamed("nameOrig","Origin_account") \
    .withColumnRenamed("nameDest","Destination_account")



df = df.withColumn("Amount",col("Amount").cast(IntegerType()))





df.count()
#5070




df.orderBy(col("Type"),col("Amount")).show()
+-------+------+--------------+-------------+--------------+-------------------+--------------+--------------+-------+
|   Type|Amount|Origin_account|oldbalanceOrg|newbalanceOrig|Destination_account|oldbalanceDest|newbalanceDest|isFraud|
+-------+------+--------------+-------------+--------------+-------------------+--------------+--------------+-------+
|CASH_IN|    82|   C1601376276|      66896.0|       66978.2|        C1176240630|         429.0|           0.0|    0.0|
|CASH_IN|   332|   C1177323824|  11097162.57|   11097494.57|         C939322176|   21547872.16|   21547540.16|    0.0|
|CASH_IN|  1147|    C103181395|   1639896.99|    1641044.85|        C1594624372|    2420885.87|    2419738.01|    0.0|
|CASH_IN|  1699|    C335993746|   3229353.26|    3231052.55|        C1743786506|     109132.55|     107433.26|    0.0|
|CASH_IN|  1887|    C260737500|   6487246.89|    6489134.69|        C1139972603|     319025.32|     317137.52|    0.0|
|CASH_IN|  3114|   C2068479160|      99857.0|     102971.66|        C1323076810|           0.0|           0.0|    0.0|
|CASH_IN|  3201|    C506512445|   3958101.17|    3961302.65|          C53279306|    1493557.78|     1490356.3|    0.0|
|CASH_IN|  3399|    C420131334|   1896880.43|    1900279.82|         C993977403|      297567.8|      294168.4|    0.0|
|CASH_IN|  4007|    C815409832|    4250157.2|    4254164.55|        C1898673154|    1325205.23|    1321197.88|    0.0|
|CASH_IN|  4229|   C1082197336|   11131670.7|   11135900.44|        C1583172368|     1114514.9|    1110285.16|    0.0|
|CASH_IN|  4623|   C2025407887|   2314585.95|    2319209.12|         C905309351|      36416.22|     331082.51|    0.0|
|CASH_IN|  5231|   C1852279575|   7336289.03|    7341520.67|        C1410197777|     564988.14|     358587.55|    0.0|
|CASH_IN|  7401|   C1935592506|     100963.0|     108364.99|        C1098169068|      150510.1|     142713.03|    0.0|
|CASH_IN|  7708|   C1796342612|   3253506.87|    3261215.52|         C352331958|    2506728.49|    2499019.84|    0.0|
|CASH_IN|  8381|    C462567674|      10097.0|      18478.84|         C475746743|      43121.81|      34739.96|    0.0|
|CASH_IN|  8965|    C795058806|  12298344.35|   12307309.63|        C1226446944|    1861043.35|    1758546.66|    0.0|
|CASH_IN| 10353|   C1342737030|   3748111.08|    3758464.93|         C322855731|      449856.5|     439502.66|    0.0|
|CASH_IN| 10409|   C1032457906|   9637529.16|    9647938.28|        C1476935098|       39839.0|           0.0|    0.0|
|CASH_IN| 10447|   C1325872186|  11594360.51|   11604807.92|        C2125822090|     172191.51|      161744.1|    0.0|
|CASH_IN| 10448|   C1008210822|      21351.0|      31799.28|         C319010261|           0.0|           0.0|    0.0|
+-------+------+--------------+-------------+--------------+-------------------+--------------+--------------+-------+
only showing top 20 rows










window_Original_Name = Window.partitionBy("Type").orderBy("Amount")

df = df.withColumn("Rank_over_type",row_number().over(window_Original_Name)).drop(col("isFraud"))
+--------+-------+--------------+-------------+--------------+-------------------+--------------+--------------+--------------+------+----------+
|    Type| Amount|Origin_account|oldbalanceOrg|newbalanceOrig|Destination_account|oldbalanceDest|newbalanceDest|Rank_over_type|Rank_2|Sum_Rank_2|
+--------+-------+--------------+-------------+--------------+-------------------+--------------+--------------+--------------+------+----------+
| CASH_IN|  72794|   C1086707064|  11067089.38|   11139883.59|        C1000374016|    2145177.28|    2072383.07|           130|     1|         1|
|CASH_OUT| 150055|   C1591606369|          0.0|           0.0|        C1000795584|    2290860.86|    2138510.96|           843|     1|         1|
|TRANSFER| 972713|    C706587857|    972713.05|           0.0|        C1000855680|           0.0|           0.0|           998|     1|         1|
| CASH_IN| 104950|    C716616104|   1821740.48|    1926691.28|        C1000909769|     358325.83|     464600.62|           204|     1|         1|
|TRANSFER|  22877|   C1247938090|      22877.0|           0.0|        C1002031672|           0.0|           0.0|           109|     1|         1|
|TRANSFER|2142164|    C181177203|    2142164.0|           0.0|        C1002183297|           0.0|           0.0|          1244|     1|         1|
|CASH_OUT| 339275|    C433192438|    339275.64|           0.0|        C1002469873|    1481576.03|    1820851.68|          1386|     1|         1|
|CASH_OUT| 139978|   C1532807515|          0.0|           0.0|        C1002545847|     1041488.6|    1384254.27|           797|     1|         1|
| CASH_IN|  48039|    C612747287|    923704.46|     971743.55|        C1003009573|     206098.87|     158059.78|           101|     1|         1|
|TRANSFER|3892156|   C1631482807|    3892156.3|           0.0|        C1003909463|           0.0|           0.0|          1356|     1|         1|
|TRANSFER|2144208|   C1923199503|   2144208.23|           0.0|        C1004490006|           0.0|           0.0|          1245|     1|         1|
| CASH_IN| 139545|   C1696881276|        105.0|     139650.75|        C1004539833|     241558.08|     102012.33|           271|     1|         1|
|CASH_OUT| 400157|   C1959804825|    400157.86|           0.0|        C1005460442|           0.0|     400157.86|          1483|     1|         1|
| CASH_IN| 135340|    C523728354|      36500.0|     171840.56|        C1005641337|    7642381.39|    7507040.83|           264|     1|         1|
|TRANSFER|1269511|   C1772043238|     100169.0|           0.0|         C100568242|     767446.25|    2036957.44|          1084|     1|         1|
|CASH_OUT| 113273|   C1323930150|     113273.1|           0.0|        C1005714733|           0.0|      113273.1|           667|     1|         1|
|CASH_OUT|  76183|   C1921583225|        101.0|           0.0|        C1006135766|           0.0|      76183.58|           466|     1|         1|
|CASH_OUT| 103808|    C598920038|          0.0|           0.0|         C100620904|     147668.97|     251477.06|           623|     1|         1|
|CASH_OUT| 938288|   C1870394283|    938288.58|           0.0|        C1006464744|           0.0|     938288.58|          1758|     1|         1|
|TRANSFER| 152331|    C397720555|    152331.26|           0.0|        C1006668962|           0.0|           0.0|           402|     1|         1|
+--------+-------+--------------+-------------+--------------+-------------------+--------------+--------------+--------------+------+----------+
only showing top 20 rows













window_desti = Window.partitionBy("Destination_account").orderBy("Amount")

df = df.withColumn("Rank_2",row_number().over(window_desti))

df = df.withColumn("Sum_Rank_2",sum(col("Rank_2"))
                   .over(Window.partitionBy("Destination_account").orderBy("Destination_account")))

df.filter(col("Sum_Rank_2") >1).display()
+--------+-------+--------------+-------------+--------------+-------------------+--------------+--------------+--------------+------+----------+
|    Type| Amount|Origin_account|oldbalanceOrg|newbalanceOrig|Destination_account|oldbalanceDest|newbalanceDest|Rank_over_type|Rank_2|Sum_Rank_2|
+--------+-------+--------------+-------------+--------------+-------------------+--------------+--------------+--------------+------+----------+
|CASH_OUT| 455074|    C695129655|    455074.13|           0.0|        C1013511446|    9237170.74|    9692244.86|          1552|     1|         3|
|CASH_OUT|2539898|    C728718059|   2539898.07|           0.0|        C1013511446|         968.0|    1842864.22|          2003|     2|         3|
|TRANSFER|1105998|   C1837109688|          0.0|           0.0|        C1032628517|     1471393.1|    2577391.21|          1040|     1|         3|
|CASH_OUT|1762680|   C1980352063|   1762680.47|           0.0|        C1032628517|    3039981.66|    4802662.12|          1919|     2|         3|
|TRANSFER| 152042|   C1118399210|    152042.16|           0.0|         C104038589|           0.0|           0.0|           401|     1|         3|
|CASH_OUT|2050727|    C992917413|   2050727.81|           0.0|         C104038589|           0.0|    2050727.81|          1957|     2|         3|
|   DEBIT|    413|    C494674818|     311647.0|      311233.5|        C1063608678|     551829.54|       1292.46|             2|     1|         3|
|CASH_OUT| 736370|    C533706573|    736370.54|           0.0|        C1063608678|     556478.62|    1292849.15|          1698|     2|         3|
| CASH_IN|   8965|    C795058806|  12298344.35|   12307309.63|        C1226446944|    1861043.35|    1758546.66|            16|     1|         3|
| CASH_IN|  93531|   C1634349283|  14946421.42|   15039952.82|        C1226446944|    1852078.07|    1758546.66|           180|     2|         3|
| CASH_IN| 118014|   C1693379246|       5551.0|     123565.91|        C1259079602|           0.0|           0.0|           232|     1|         3|
|TRANSFER| 534255|    C967325382|    534255.94|           0.0|        C1259079602|           0.0|           0.0|           800|     2|         3|
|CASH_OUT| 122377|   C1632677830|    211812.91|      89435.23|        C1394526584|     223900.19|     618730.52|           718|     1|         3|
|CASH_OUT| 169941|   C2026325575|    169941.73|           0.0|        C1394526584|           0.0|     169941.73|           930|     2|         3|
| CASH_IN|  14707|    C927310301|       1963.0|      16670.01|         C146134851|      46350.32|      31643.31|            28|     1|         3|
|CASH_OUT|  37748|    C490140017|         73.0|           0.0|         C146134851|           0.0|      37748.61|           259|     2|         3|
|CASH_OUT| 325867|   C1369632200|          0.0|           0.0|        C1499489682|    4412358.94|    4838577.59|          1353|     1|         3|
|CASH_OUT|4022667|     C79951219|   4022667.54|           0.0|        C1499489682|      80136.56|    4057191.21|          2081|     2|         3|
| CASH_IN| 307528|   C1501710101|        484.0|     308012.68|        C1583408697|    1409212.38|    1101683.71|           478|     1|         3|
| CASH_IN| 376030|    C438479639|   1405259.15|    1781290.01|        C1583408697|    1437885.61|    1042184.23|           516|     2|         3|
+--------+-------+--------------+-------------+--------------+-------------------+--------------+--------------+--------------+------+----------+
only showing top 20 rows

















